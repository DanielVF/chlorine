<!DOCTYPE html>
<html>
<head>
	<title>Chlorine</title>
	<style>
		body {
			margin: 0;
			border: 0;
			padding: 0;
			background-color: black;
			font-family: "Courier";
			pointer-events: none;
			user-select: none;
			cursor: default;
			overflow: hidden;
		}
	</style>
</head>
<body>

<canvas id="canvas" width="0" height="0" style="position: absolute;"></canvas>

<script>

	"use strict";

	const fs = require("fs");
	const ipcRenderer = require("electron").ipcRenderer;
	const stream = require("stream");
	const zstd = require("node-zstandard");

	const canvas = document.getElementById("canvas");
	const context = canvas.getContext("2d");

	canvas.width = window.innerWidth;
	canvas.height = window.innerHeight;

	function make_renderer() {

		let renderer = {};

		renderer.game = null;
		renderer.turn = 0;
		renderer.scale = 0;

		renderer.open = (filename) => {

			let loading_string = "";
			let loading_stream = new stream.Writable();

			loading_stream._write = (chunk, encoding, done) => {
				loading_string += chunk.toString();
				done();
			};

			zstd.decompressFileToStream(filename, loading_stream, (err, result) => {
				if (err) {
					alert("Couldn't load this file")
				}
				result.on("error", (err) => {
					alert("Couldn't load this file")
				});
				result.on("finish", () => {
					renderer.game = JSON.parse(loading_string);
					renderer.turn = 0;
					renderer.scale = canvas.width / renderer.game.width
					renderer.draw();
				});
			});
		};

		renderer.save = (filename) => {

			if (!filename || !renderer.game) {
				return;
			}

			fs.writeFileSync(filename, JSON.stringify(renderer.game, null, "\t"));
		};

		renderer.draw = () => {
			renderer.draw_planets();
			renderer.draw_ships();
		};

		renderer.draw_planets = () => {

			let index = renderer.turn;

			if (index >= renderer.game.frames.length) {
				index = renderer.game.frames.length - 1;
			}

			let frame = renderer.game.frames[index];

			let game_planets = renderer.game.planets;

			for (let i = 0; i < game_planets.length; i++) {

				let id = i.toString();

				let planet = frame.planets[id];

				if (planet) {

					planet.r = game_planets[i].r;
					planet.x = game_planets[i].x;
					planet.y = game_planets[i].y;

					let x = Math.floor(planet.x * renderer.scale);
					let y = Math.floor(planet.y * renderer.scale);
					let r = Math.floor(planet.r * renderer.scale);

					context.lineWidth = 5;
					context.strokeStyle = "red";
					context.beginPath();
					context.arc(x, y, r, 0, Math.PI * 2, true);
					context.stroke();
				}
			}
		};

		renderer.draw_ships = () => {

			let index = renderer.turn;

			if (index >= renderer.game.frames.length) {
				index = renderer.game.frames.length - 1;
			}

			let frame = renderer.game.frames[index];

			for (let i = 0; i < 4; i++) {

				let pid = i.toString();

				let player_ships = frame.ships[pid];

				if (player_ships) {

					for (let key in player_ships) {

						if (player_ships.hasOwnProperty(key)) {

							let ship = player_ships[key];

							let x = Math.floor(ship.x * renderer.scale);
							let y = Math.floor(ship.y * renderer.scale);
							let r = Math.floor(1 * renderer.scale);

							context.lineWidth = 2;
							context.strokeStyle = "white";
							context.beginPath();
							context.arc(x, y, r, 0, Math.PI * 2, true);
							context.stroke();
						}
					}
				}
			}
		}

		return renderer;
	}

	let renderer = make_renderer();

	ipcRenderer.on("open", (event, filename) => {
		renderer.open(filename);
	});

	ipcRenderer.on("save", (event, filename) => {
		renderer.save(filename);
	});

</script>
</body>
</html>
